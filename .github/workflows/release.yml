name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  BUN_VERSION: 'latest'

jobs:
  # Build Windows MSI
  build-windows:
    name: Build Windows MSI
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install dependencies
        run: bun install

      - name: Ensure dist folder exists
        shell: bash
        run: |
          mkdir -p dist
          if [ ! -f dist/index.html ]; then
            echo "Creating dist/index.html..."
            cat > dist/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Karaoke Successor - Loading...</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                font-family: 'Segoe UI', system-ui, sans-serif;
                background: linear-gradient(135deg, #0a0a1a 0%, #1a0a2e 50%, #2d1b4e 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
              }
              .container { text-align: center; padding: 40px; }
              .logo { font-size: 80px; margin-bottom: 20px; animation: pulse 2s infinite; }
              @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
              @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
              .spinner { width: 50px; height: 50px; border: 4px solid rgba(0, 255, 255, 0.3); border-top-color: #00ffff; border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
              h1 { font-size: 2rem; margin-bottom: 10px; background: linear-gradient(90deg, #00ffff, #ff00ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
              .status { color: rgba(255,255,255,0.7); font-size: 14px; margin-top: 10px; }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="logo">üé§</div>
              <h1>Karaoke Successor</h1>
              <div class="spinner"></div>
              <p class="status">Starting server... Please run 'bun run dev' manually if this takes too long.</p>
            </div>
            <script>
              let attempts = 0;
              function checkServer() {
                attempts++;
                fetch('http://localhost:3000', { method: 'HEAD', mode: 'no-cors' })
                  .then(() => { window.location.href = 'http://localhost:3000'; })
                  .catch(() => { if (attempts < 120) setTimeout(checkServer, 500); });
              }
              setTimeout(checkServer, 1000);
            </script>
          </body>
          </html>
          HTMLEOF
          fi
          ls -la dist/

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.event.inputs.version || github.ref_name }}
          releaseName: 'Karaoke Successor ${{ github.event.inputs.version || github.ref_name }}'
          releaseBody: |
            # üé§ Karaoke Successor
            
            The ultimate karaoke experience with real-time pitch detection!
            
            ## üì• Installation
            
            ### Windows
            1. Download the `.msi` file
            2. Run the installer
            3. Make sure [Bun](https://bun.sh) or Node.js is installed
            4. Launch "Karaoke Successor" from Start Menu
            
            ## ‚ú® Features
            - Real-time pitch detection (YIN algorithm)
            - 3 difficulty levels
            - Party modes (Pass the Mic, Duel, Medley, etc.)
            - Mobile companion app (use phone as microphone)
            - Song import (UltraStar, MIDI, SingStar formats)
            - Highscores with 21 funny ranking titles
            
            ## ‚ö†Ô∏è Requirements
            - [Bun](https://bun.sh) or Node.js 18+ must be installed
          releaseDraft: true
          prerelease: false

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: src-tauri/target/release/bundle/msi/*.msi
          retention-days: 30
          if-no-files-found: warn

  # Build macOS DMG
  build-macos:
    name: Build macOS DMG
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin, x86_64-apple-darwin

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install dependencies
        run: bun install

      - name: Ensure dist folder exists
        run: |
          mkdir -p dist
          ls -la dist/

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.event.inputs.version || github.ref_name }}
          releaseName: 'Karaoke Successor ${{ github.event.inputs.version || github.ref_name }}'
          releaseBody: 'Automated release'
          releaseDraft: true
          prerelease: false

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: src-tauri/target/release/bundle/dmg/*.dmg
          retention-days: 30
          if-no-files-found: warn

  # Build Linux AppImage
  build-linux:
    name: Build Linux AppImage
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev

      - name: Install dependencies
        run: bun install

      - name: Ensure dist folder exists
        run: |
          mkdir -p dist
          ls -la dist/

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.event.inputs.version || github.ref_name }}
          releaseName: 'Karaoke Successor ${{ github.event.inputs.version || github.ref_name }}'
          releaseBody: 'Automated release'
          releaseDraft: true
          prerelease: false

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: src-tauri/target/release/bundle/appimage/*.AppImage
          retention-days: 30
          if-no-files-found: warn
